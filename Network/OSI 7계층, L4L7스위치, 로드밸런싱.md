# OSI 7 계층 모델
> 국제표준화기구 ISO 에서 개발한 모델.
> 
> 네트워크 통신을 계층화해 계층 별 독립적인 역할 분담과 문제발생시 원인 파악을 용이하게 하기위해 개발한 표준 규격.
>
> 각각의 계층별 프로토콜 데이터 단위를 맞추기 위해 상위계층에서 하위계층으로 내려갈수록 **캡슐화**, 하위계층에서 상위계층으로 올라갈수록 **역캡슐화** 진행.

<br/>

![1](https://github.com/user-attachments/assets/f6c58575-92b4-44d7-9b1c-0c7a6e7ea45e)

### 7계층. 응용 계층 Application Layer

- 응용 프로그램의 정보를 활용하고 통신을 제어.
- 사용자와 직접 상호작용하는 계층.
- 프로토콜 : HTTP, SMTP, FTP, SSL 등

### 6계층. 표현 계층 Presentation Layer

- 송/수신측간 데이터 형식을 정의.
- 수신한 데이터를 변환, 검색, 암호화, 압축 등의 과정을 거쳐 올바른 방식으로 변환.
- 문자의 인코딩 방식을 변환.
- 프로토콜 : png, jpg, zip, ASCII 등

### 5계층. 세션 계층 Session Layer

- `포트번호`를 기반으로 통신 세션을 구성하고 상호작용과 동기화 제공. 연결 세션에서 에러복구, 데이터 교환을 담당.
- 프로토콜 : SSH, TLS, RPC 등

### 4계층. 전송 계층 Transport Layer

- 노드간 신뢰성 있고 정확한 정보 전송을 담당.
- 네트워크 계층의 패킷 전송을 제어하는 역할.
    - 패킷 재전송, 에러복구, 흐름제어 등
- 실질적인 정보 전송과 논리적 연결 사이 다리 역할.
- PDU : **Segment**
- 프로토콜 : TCP, UDP 등

### 3계층. 네트워크 계층 Network Layer

- 기기간 연결을 위한 주소와 경로를 정하는 방법을 규정.
    - 최적 경로 설정, 패킷 정보 전송 등.
- 여러개의 노드를 거칠 때 마다 경로를 찾는 역할.
- 전송계층에서 전달 받은 정보를 적당한 크기로 쪼개고 각각에 헤더를 추가해 패킷을 생성.
    - 각각의 헤더는 논리주소를 포함.
- PDU : **Packet**
- 프로토콜 : IP, ICMP 등

### 2계층. 데이터 링크 계층 Data Link Layer

- 네트워크 계층에서 전달 받은 정보에 프레임 헤더/트레일러를 추가해 기기간 논리적 전송로를 정하는 방법을 규정.
- 물리 계층을 통해 전달 받은 정보의 전송 오류를 감지하는 역할을 수행.
- PDU : **Frame**
- 프로토콜 : MAC, LAN 등

### 1계층. 물리 계층 Physical Layer

- 장치간 정보 송/수신을 위한 전기/기계/기능적 세부 사항을 정의한다.
- 노드간 데이터 전송에 집중하기때문에 데이터의 송수신 역할을 담당한다.
- 디지털 비트를 전기/무선/광 신호로 변환 하는 기능 수행.
- PDU : **bit**
- 프로토콜 : 모뎀, RS-232 등

<br/>

## TCP/IP 4계층 모델

> 두 계층 모델간 개발 시기가 다르고 OSI 모델은 장비개발과 통신 자체에 대한 표준을 정의하고, TCP/IP 프로토콜을 사용한다. 
> 
> OSI 모델이 표준과 학습도구로써의 의의가 있다면 TCP/IP 모델은 실무적인 통신 기술을 구현하는데 의미를 가진다.


![1](https://github.com/user-attachments/assets/f6c58575-92b4-44d7-9b1c-0c7a6e7ea45e)

### 4계층. 응용 계층 Application Layer

- TCP/UDP 기반의 응용 프로그램을 구현할 때 사용
- FTP, HTTP, SSH

### 3계층. 전송 계층 Transport Layer

- 통신 노드 간 연결을 제어하고, 신뢰성 있는 데이터 전송을 담당

### 2계층. 인터넷 계층 Internet Layer

- 통신 노드 간의 IP 패킷 전송, 라우팅을 담당

### 1계층. 링크 계층 Link Layer

- MAC 주소를 사용하며, LAN, 패킷망 등에 사용됨

<br/>

### OSI 7계층 모델과 TCP/IP 4계층 모델의 공통점

- 계층별 역할
    - 캡슐화, 프로토콜 사용.
    - 계층간 역할을 정의.
- 통신 역할
    - 다중화, 역다중화
    - 페이로드 전송기능

### OSI 7계층 모델과 TCP/IP 4계층 모델의 차이점

- OSI 모델을 역할을 기반으로 각 계층을 구성하고, TCP/IP 모델을 프로토콜의 집합을 기반으로 구성된다.
- 전체적인 통신전반에 대한 표준화 방식이 OSI 모델이라면 TCP/IP 모델은 데이터 전송에 특화되어있다.

<br/>

## Encapsulation & Decapsulation

![2](https://github.com/user-attachments/assets/e6f15dab-3133-43f3-ba1e-1f4d82d4c7e7)

- 각 계층은 독립적이므로 데이터가 전달되는 동안 다른 계층의 영향을 받지 않는다.
    - 예를 들어 전송 계층에서 TCP를 UDP로 변경했다고 해서 인터넷 웹 브라우저를 다시 설치해야 하는 것은 아니다.
- 데이터 송신부에서 상위 계층으로 하위 계층으로 데이터를 전달할 때, 각 계층에서 필요한 정보를 데이터 헤더에 추가한다. 이렇게 헤더를 붙여나가는 것을 캡슐화라고 한다.
- 데이터 수신부는 하위 계층에서 상위 계층으로 각 계층을 통해 전달된 데이터를 받게 된다. 이때 상위 계층으로 데이터를 전달하며 각 계층에서 헤더를 제거해 나가는 것을 역캡슐화라고 한다. 역캡슐화를 거쳐 마지막 응용계층에 도달하면 송신부에서 전달하고자 했던 데이터가 남는다.

<br/>

---

<br/>

# L7/L4 스위치, 로드밸런싱

## 로드밸런싱

로드밸런싱은 여러 서버 간에 네트워크 트래픽을 분산하여 특정 서버에 과부하가 걸리지 않도록 조정하는 기술이다.
이를 통해 응답 시간을 줄이고, 애플리케이션의 가용성과 성능을 향상시킬 수 있다.

![3](https://github.com/user-attachments/assets/14e5e82d-7536-4c8c-b7f1-581675ab95ea)

![4](https://github.com/user-attachments/assets/9f8410a5-b57d-47ba-8fe5-ff056dbfbd01)


### 로드밸런싱의 목적

- 서버 자원 사용의 최적화
- 데이터 처리량의 증가
- 클라이언트와 서버 간 응답속도 감소
- 특정 서버의 과부화 방지
- 안정성, 가용성 극대화

### 주요 로드밸런싱 방식

- **DNS 기반 로드밸런싱**: 클라이언트의 요청을 여러 서버로 분산시키는 가장 단순한 방식으로, DNS 서버가 여러 IP 주소 중 하나를 선택.
- **소프트웨어 기반 로드밸런싱**: 소프트웨어로 트래픽을 관리하고 분배하는 방식으로, 대표적인 예로 NGINX, HAProxy 등이 있음.
- **하드웨어 기반 로드밸런싱**: L4, L7 스위치와 같은 전용 하드웨어 장비를 통해 고성능, 저지연 로드밸런싱을 수행.

<br/>

## **주요 로드밸런싱 알고리즘**

### 정적 부하분산 Static Load Balancing

- **Round Robin**
    - 입력받은 요청을 각각의 서버에 순차적으로 할당하는 방식. 클라이언트의 요청을 순서대로 분배하기 때문에 알고리즘이 단순하고 각 서버가 트래픽을 골고루 나눠서 처리한다.각 서버의 처리량이 비슷할 경우 운용.

![5](https://github.com/user-attachments/assets/9d3ba99d-337c-4d72-8b50-ad3f23804b71)

- IP Hash
    - 클라이언트의 IP주소를 특정 서버에 매핑해 특정 IP에서 전달받은 요청을 항상 매핑된 서버로 보내는 방식.클라이언트는 항상 동일한 서버로 접속하게된다.

![6](https://github.com/user-attachments/assets/a4c1a04a-699a-4cce-a771-1bb5fb5e140a)

### 동적 부하분산 Dynamic Load Balancing

- **Weighted Round Robin**
    - 각 서버별로 가중치를 설정하고 가중치가 가장 높은 서버에 트래픽을 우선 배정한다. 클라이언트 입력이 100이고 서버 A, B, C의 가중치가 2, 3, 5라고 가정했을 때 각 서버에는 20, 30, 50의 입력이 Round Robin 방식으로 전달된다. 각 서버의 처리량이 상이할 경우 운용.

![7](https://github.com/user-attachments/assets/f57d0a7f-15a9-4edb-b4e6-c9d7c1806b11)

- Least Connection
    - 해당 시점에서 연결된 요청이 가장 적은 서버로 요청을 보낸다. 세션 유지시간이 길거나 서버에 분산된 트래픽이 일정하지 않은 경우 운용.
- Least Response Time
    - 클라이언트 요청을 전달하기 전 각 서버에 응답을 요청하고 응답시간이 가장 짧은 서버에 클라이언트 요청을 전달한다각 서버의 성능이 상이할 경우 운용.

### 로드밸런서의 종류

- **L4 로드밸런싱**
    - IP, MAC, PORT 등 OSI 7 계층 중 4계층(전송계층) 이하 프로토콜의 헤더를 기반으로 부하를 분산한다.
- **L7 로드밸런싱**
    - L4의 기능 + HTTP, FTP, SMTP 등 OSI 7 계층 중 7계층(애플리케이션계층) 이하 프로토콜 헤더를 기반으로 부하를 분산한다.

<br/>

## L4/L7 스위치

### 네트워크 스위치

- 네트워크 스위치는 클라이언트를 요청한 주소에 맞게 목적지와 중계해주는 역할을 한다.
- 이는 스위치 레이어 레벨에 관계 없이 서버의 실제 주소를 숨기는 역할을 한다.
- 특히 L4/L7스위치는 로드밸런싱의 기능을 수행한다.
- 4 ~ 7 계층 스위치는 하위계층 스위치의 기능을 포함한다.

### L4 스위치

- 클라이언트 요청의 프로토콜 헤더(IP, PORT)를 기반으로 Source IP와 Destination IP를 변조해 다중화된 서버와 중계해주는 역할을 하기에 IP, PORT 를 기반으로 한 로드밸런싱을 수행한다.
- 클라이언트가 TCP 프로토콜로 서버에 접속하려 할 경우 목적지 서버와 `연결 성립 과정(3-Way HandShake)`을 거쳐 커넥션이 생성되는데 L4스위치에서도 커넥션 데이터를 생성해 관리한다.
    - 이때 연결이 일정시간동안 사용되지 않을 경우 커넥션을 삭제하는 값을 가진다.

### L7 스위치

- 어플리케이션 계층에서 동작하는 `L7 스위치`는 트래픽 내용(URI, Payload, Cookie, HTTP 헤더 등)을 직접 분석할 수 있어 `L4 스위치`보다 정교한 로드밸런싱에 사용된다.
- `L4 스위치`에 비해 자원의 소모가 크다.

### L4 vs L7

### 공통점

- 도달한 패킷을 적절한 목적지로 보내준다.
- 로드밸런싱기능을 수행한다.

### 차이점

- TCP 프로토콜
    - `L4 스위치`는 중계된 서버와 클라이언트간 `연결 성립 과정(3-Way HandShake)`을 통해 하나의 세션을 생성한다.
    - `L7 스위치`는 클라이언트와 스위치, 스위치와 서버간 `연결 성립 과정(3-Way HandShake)`을 통해 각각의 TCP 세션을 생성한다.
- `L7 스위치는` 패킷, 페이로드의 분석을 통해 `패킷 필터링` 기능을 수행할 수 있다.
- Mega Proxy Problem
    - `L4 스위치`에서 `IP Hash`방식으로 부하를 분산할 경우 특정 서버에 요청이 집중되는 현상이 발생할 수 있다.

<br/>

# 질문

- OSI 7 계층으로 나누는 이유?
    - 통신 과정을 단계적으로 파악할 수 있고 트러블 슈팅을 용이하게 해주며 독립적인 계층으로 나누었을 경우 각 계층이 독립적으로 발전 할 수 있습니다.
    마치 자동차의 타이어를 교체하는것 처럼 다양한 유형의 프로토콜에 적용 할 수 있습니다.
- 로드밸런싱이란?
    - 하나의 서버로 안정적으로 서비스를 제공하기 어려워 Scale Out 할 경우
    클라이언트에게 다수의 서버 선택지를 주는것이 아닌 글로벌 서버 주소를 제공하고 요청받은 트래픽을 적절히 분산해주는 기술입니다.
- L4 로드밸런싱과 L7 로드밸런싱의 장단점?
    - L4 로드밸런싱의 경우 패킷 페이로드까지 접근하지 않아 속도가 빠르고 자원 효율이 좋으며 비용이 저렴하지만 세밀한 로드밸런싱이 어렵고 서버와의 4계층 연결이 끊어지지 않는 이상 장애를 판단하기 어렵습니다.
    - L7 로드밸런싱의 경우 비정상 트래픽을 판단할 수 있고 정교한 로드밸런싱이 가능하지만 비용이 크고 속도와 자원 효율성이 감소합니다.
- 로드밸런싱 알고리즘 중 라운드로빈 방식의 장단점?
    - 패킷을 요청받은 각 서버에 순서대로 할당하기때문에 알고리즘이 간단합니다. 하지만 이 경우 특정 서버에 장애가 발생해 성능이 저하될 경우 처리속도가 느려질 가능성이 있습니다.

<br/>

# 참고자료

- 로드 밸런싱의 작동 방식 이해 : https://www.cisco.com/c/ko_kr/support/docs/ip/border-gateway-protocol-bgp/5212-46.html
- [네트워크] 로드밸런서의 기본 : https://etloveguitar.tistory.com/136
- 로드밸런싱 (Load Balancing) : [https://velog.io/@come_true/로드밸런싱-Load-Balancing](https://velog.io/@come_true/%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-Load-Balancing)
